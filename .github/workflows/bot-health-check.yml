name: Bot Health Check

on:
  schedule:
    # Check bot health every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r bot/requirements.txt
      
      - name: Validate bot configuration
        run: |
          echo "🔍 Validating bot configuration..."
          python -c "
          import os, sys
          sys.path.append('bot')
          
          # Check if main.py imports correctly
          try:
              import main
              print('✅ Bot imports successfully')
          except Exception as e:
              print(f'❌ Bot import failed: {e}')
              sys.exit(1)
          
          # Check required environment variables are documented
          required_vars = ['DISCORD_TOKEN', 'GITHUB_TOKEN', 'GITHUB_REPO']
          with open('bot/.env.example', 'r') as f:
              content = f.read()
              for var in required_vars:
                  if var in content:
                      print(f'✅ {var} documented in .env.example')
                  else:
                      print(f'⚠️ {var} missing from .env.example')
          "
      
      - name: Check submission file structure
        run: |
          echo "📁 Checking submission directory structure..."
          mkdir -p submissions/bo3
          echo "✅ Submission directories ready"
      
      - name: Validate leaderboard script
        run: |
          echo "📊 Validating leaderboard update script..."
          python -c "
          import sys
          sys.path.append('actions')
          
          try:
              exec(open('actions/update_leaderboard.py').read())
              print('✅ Leaderboard script syntax is valid')
          except Exception as e:
              print(f'❌ Leaderboard script error: {e}')
              sys.exit(1)
          "
      
      - name: Summary
        run: |
          echo "## 🤖 Bot Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All systems operational**" >> $GITHUB_STEP_SUMMARY
          echo "- Bot configuration valid" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies up to date" >> $GITHUB_STEP_SUMMARY
          echo "- Leaderboard script functional" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Last checked: $(date -u)" >> $GITHUB_STEP_SUMMARY