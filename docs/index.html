<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BAR Winter Duel Championship - Leaderboard & Replays</title>
  <meta name="description" content="Live standings for the Beyond All Reason Winter Duel Championship with automatic updates, tiered rankings, and comprehensive replay database.">
  <link rel="stylesheet" href="static/css/styles.css">
  <style>
    body{background:#0d1117;color:#c9d1d9;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0}
    .container{max-width:900px;margin:2rem auto;background:#161b22;border:1px solid #30363d;border-radius:8px;padding:2rem}
    h1{text-align:center;border-bottom:1px solid #30363d;padding-bottom:1rem;margin-top:0}
    .table-container{overflow-x:auto;border-radius:8px;border:1px solid #30363d}
    table{width:100%;border-collapse:collapse}
    th,td{padding:1rem;border-bottom:1px solid #30363d;text-align:left}
    th{color:#8b949e;font-weight:600}
    tbody tr:hover{background:#1c2128}
    td.rank{text-align:center;color:#58a6ff;font-weight:700}
    .summary-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .summary-card{background:#161b22;border:1px solid #30363d;border-radius:8px;padding:20px;text-align:center}
    .summary-number{font-size:2em;color:#58a6ff;font-weight:bold;display:block}
    .header-status{margin:1rem auto 2rem;padding:1rem;border:1px solid rgba(255,255,255,.1);border-radius:12px;background:rgba(255,255,255,.05);text-align:center}
    .footer-logo{display:block;margin:2rem auto 0;max-height:70px;opacity:.7}
    .tier-badge img{height:1.2em;width:1.2em;vertical-align:middle;margin-right:0.3em;display:inline-block}
    .tier-heading .tier-badge img{height:1.4em;width:1.4em}
    .tier-chip .tier-badge img{height:1em;width:1em;margin-right:0.25em}
    h1 .tier-badge img{height:1.5em;width:1.5em}
    
    /* Navigation styles */
    .nav-tabs{display:flex;border-bottom:1px solid #30363d;margin-bottom:2rem}
    .nav-tab{padding:1rem 1.5rem;background:none;border:none;color:#8b949e;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s ease}
    .nav-tab:hover{color:#c9d1d9;background:rgba(255,255,255,0.05)}
    .nav-tab.active{color:#58a6ff;border-bottom-color:#58a6ff}
    
    /* Content sections */
    .content-section{display:none}
    .content-section.active{display:block}
    
    /* Replay styles */
    .replay-grid{display:grid;gap:1rem;margin-top:1rem}
    .replay-card{background:#161b22;border:1px solid #30363d;border-radius:8px;padding:1rem;transition:all 0.2s ease}
    .replay-card:hover{background:#1c2128;border-color:#58a6ff}
    .replay-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem}
    .replay-title{font-weight:600;color:#c9d1d9}
    .replay-date{font-size:0.85rem;color:#8b949e}
    .replay-players{display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem}
    .player-vs{display:flex;align-items:center;gap:0.5rem}
    .player-name{color:#c9d1d9}
    .player-name.winner{color:#3fb950}
    .vs-separator{color:#8b949e;font-weight:bold}
    .replay-details{display:flex;gap:1rem;margin-bottom:0.5rem;font-size:0.9rem;color:#8b949e}
    .replay-tags{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.5rem}
    .replay-tag{background:rgba(88,166,255,0.1);color:#58a6ff;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.75rem}
    .replay-actions{display:flex;gap:0.5rem}
    .btn{padding:0.5rem 1rem;border-radius:6px;border:none;cursor:pointer;text-decoration:none;display:inline-block;font-size:0.85rem;transition:all 0.2s ease}
    .btn-primary{background:#238636;color:#fff}
    .btn-primary:hover{background:#2ea043}
    .btn-secondary{background:#21262d;border:1px solid #30363d;color:#c9d1d9}
    .btn-secondary:hover{background:#30363d}
    .view-all-btn{display:block;text-align:center;margin:1rem auto 0;padding:0.8rem 1.5rem;background:#21262d;border:1px solid #30363d;color:#58a6ff;text-decoration:none;border-radius:8px;transition:all 0.2s ease}
    .view-all-btn:hover{background:#30363d;border-color:#58a6ff}
  </style>
</head>
<body>
  <main class="container">
    <h1 id="leaderboardTitle">
           BAR Winter Duel Championship
    </h1>

    <nav class="nav-tabs">
      <button class="nav-tab active" onclick="showSection('leaderboard-section')" id="leaderboard-tab">Leaderboard</button>
      <button class="nav-tab" onclick="showSection('replays-section')" id="replays-tab">Recent Replays</button>
    </nav>

    <div id="leaderboard-section" class="content-section active">
      <section class="summary-stats" id="stats">
        <article class="summary-card">
          <span class="summary-number" id="total-players">-</span>
          <span class="summary-label">Players</span>
        </article>
        <article class="summary-card">
          <span class="summary-number" id="total-matches">-</span>
          <span class="summary-label">Matches played</span>
        </article>
        <article class="summary-card">
          <span class="summary-number" id="active-tiers">-</span>
          <span class="summary-label">Active tiers</span>
        </article>
      </section>

      <div class="last-updated" style="text-align:center;color:#8b949e;margin-bottom:1.5rem;font-style:italic;">
        Last updated: <span id="update-time">-</span>
      </div>

      <div id="leaderboard" class="table-container">
        <div class="loading">Loading leaderboardâ€¦</div>
      </div>
    </div>

    <div id="replays-section" class="content-section">
      <section class="summary-stats" id="replay-stats">
        <article class="summary-card">
          <span class="summary-number" id="total-replays">-</span>
          <span class="summary-label">Total Replays</span>
        </article>
        <article class="summary-card">
          <span class="summary-number" id="total-playtime">-</span>
          <span class="summary-label">Total Playtime</span>
        </article>
        <article class="summary-card">
          <span class="summary-number" id="unique-maps">-</span>
          <span class="summary-label">Unique Maps</span>
        </article>
      </section>

      <div id="recent-replays" class="replay-grid">
        <div class="loading">Loading recent replaysâ€¦</div>
      </div>

      <a href="replays.html" class="view-all-btn">
        ðŸŽ® View All Replays & Search Database
      </a>
    </div>
  </main>

  <footer>
    <img src="static/images/tiers/gold.svg" alt="" class="footer-logo">
  </footer>

  <script>
    const LEADERBOARD_URL = 'https://raw.githubusercontent.com/Atlasfailed/bar-duel-championship/main/public/data/leaderboard.json';
    const REPLAY_DATABASE_URL = 'https://raw.githubusercontent.com/Atlasfailed/bar-duel-championship/main/public/data/replay_database.json';
    const REFRESH_INTERVAL_MS = 5 * 60 * 1000;
    const TIER_ORDER = ['Master','Diamond','Platinum','Gold','Silver','Bronze'];
    let hasRenderedLeaderboard = false;
    let hasRenderedReplays = false;
    let allReplays = [];

    function escapeHtml(value){
      const div=document.createElement('div'); div.textContent=value ?? ''; return div.innerHTML;
    }

    function getTierBadgeHTML(tier){
      const map={ 
        Master:'master', 
        Grandmaster:'master', // Use master.svg for grandmaster as well
        Diamond:'diamond', 
        Platinum:'platinum', 
        Gold:'gold', 
        Silver:'silver', 
        Bronze:'bronze' 
      };
      const key=map[tier] || 'bronze';
      const src=`static/images/tiers/${key}.svg`;
      const alt=`${tier} badge`;
      return `<span class="tier-badge" aria-hidden="true"><img src="${src}" alt="${alt}" loading="lazy"></span>`;
    }

    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active from all tabs
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(sectionId).classList.add('active');
      
      // Activate corresponding tab
      if (sectionId === 'leaderboard-section') {
        document.getElementById('leaderboard-tab').classList.add('active');
      } else if (sectionId === 'replays-section') {
        document.getElementById('replays-tab').classList.add('active');
        if (!hasRenderedReplays) {
          loadReplays();
        }
      }
    }

    async function loadLeaderboard(){
      const leaderboardEl=document.getElementById('leaderboard');
      if (leaderboardEl && !hasRenderedLeaderboard){
        leaderboardEl.innerHTML='<div class="loading">Loading leaderboardâ€¦</div>';
      }
      try{
        const response=await fetch(`${LEADERBOARD_URL}?t=${Date.now()}`);
        if(!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const data=await response.json();
        // Handle both old format (array) and new format (object with entries)
        const entries = Array.isArray(data) ? data : (data.entries || []);
        const updatedAt = data.updated_at || null;
        displayLeaderboard(entries);
        updateStats(entries, updatedAt);
      }catch(err){
        if (!leaderboardEl) return;
        leaderboardEl.innerHTML=`
          <div class="error" style="text-align:center;padding:2rem;color:#dc3545;border:1px solid #dc3545;border-radius:8px;margin:20px 0;">
            <h3 style="margin:0 0 .5rem 0;color:#dc3545">Failed to load leaderboard</h3>
            <p style="margin:0 0 1rem 0;color:#8b949e">${escapeHtml(err.message)}</p>
            <button class="retry-button" type="button" style="padding:.6rem 1rem;background:#58a6ff;color:#0d1117;border:1px solid #58a6ff;border-radius:6px;cursor:pointer;">Retry</button>
          </div>`;
        const btn=leaderboardEl.querySelector('.retry-button');
        if(btn){ btn.addEventListener('click', ()=>{ hasRenderedLeaderboard=false; loadLeaderboard(); }); }
      }
    }

    async function loadReplays(){
      const replaysEl=document.getElementById('recent-replays');
      if (replaysEl && !hasRenderedReplays){
        replaysEl.innerHTML='<div class="loading">Loading recent replaysâ€¦</div>';
      }
      try{
        const response=await fetch(`${REPLAY_DATABASE_URL}?t=${Date.now()}`);
        if(!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const data=await response.json();
        allReplays = data;
        displayRecentReplays(data.slice(0, 5)); // Show 5 most recent
        updateReplayStats(data);
      }catch(err){
        if (!replaysEl) return;
        replaysEl.innerHTML=`
          <div class="error" style="text-align:center;padding:2rem;color:#dc3545;border:1px solid #dc3545;border-radius:8px;margin:20px 0;">
            <h3 style="margin:0 0 .5rem 0;color:#dc3545">Failed to load replays</h3>
            <p style="margin:0 0 1rem 0;color:#8b949e">${escapeHtml(err.message)}</p>
            <button class="retry-button" type="button" style="padding:.6rem 1rem;background:#58a6ff;color:#0d1117;border:1px solid #58a6ff;border-radius:6px;cursor:pointer;">Retry</button>
          </div>`;
        const btn=replaysEl.querySelector('.retry-button');
        if(btn){ btn.addEventListener('click', ()=>{ hasRenderedReplays=false; loadReplays(); }); }
      }
    }

    function displayRecentReplays(replays) {
      const replaysEl = document.getElementById('recent-replays');
      if (!replaysEl) return;
      
      if (!Array.isArray(replays) || replays.length === 0) {
        replaysEl.innerHTML = '<div class="message" style="text-align:center;padding:2rem;color:#8b949e;">No recent replays found</div>';
        hasRenderedReplays = true;
        return;
      }

      let html = '';
      replays.forEach(replay => {
        const player1 = replay.players[0] || {};
        const player2 = replay.players[1] || {};
        const date = formatDate(replay.date);
        const tags = replay.tags.slice(0, 3); // Show first 3 tags
        
        html += `
          <div class="replay-card">
            <div class="replay-header">
              <div class="replay-title">${escapeHtml(replay.map || 'Unknown Map')}</div>
              <div class="replay-date">${date}</div>
            </div>
            <div class="replay-players">
              <div class="player-vs">
                <span class="player-name ${player1.is_winner ? 'winner' : ''}">${escapeHtml(player1.name || 'Unknown')}</span>
                <span class="vs-separator">vs</span>
                <span class="player-name ${player2.is_winner ? 'winner' : ''}">${escapeHtml(player2.name || 'Unknown')}</span>
              </div>
            </div>
            <div class="replay-details">
              <span>Duration: ${replay.duration_formatted || 'Unknown'}</span>
              <span>Winner: ${escapeHtml(replay.winner || 'Unknown')}</span>
            </div>
            <div class="replay-tags">
              ${tags.map(tag => `<span class="replay-tag">${escapeHtml(tag)}</span>`).join('')}
            </div>
            <div class="replay-actions">
              <a href="${replay.url}" target="_blank" class="btn btn-primary">View Replay</a>
              <button class="btn btn-secondary" onclick="copyToClipboard('${replay.url}')">Copy Link</button>
            </div>
          </div>
        `;
      });

      replaysEl.innerHTML = html;
      hasRenderedReplays = true;
    }

    function updateReplayStats(replays) {
      const totalReplaysEl = document.getElementById('total-replays');
      const totalPlaytimeEl = document.getElementById('total-playtime');
      const uniqueMapsEl = document.getElementById('unique-maps');

      const totalReplays = replays.length;
      
      // Calculate total playtime
      const totalMs = replays.reduce((sum, replay) => sum + (replay.duration_ms || 0), 0);
      const totalHours = Math.floor(totalMs / (1000 * 60 * 60));
      const playtimeText = totalHours > 0 ? `${totalHours}h` : 'N/A';
      
      // Count unique maps
      const maps = new Set();
      replays.forEach(replay => {
        if (replay.map && replay.map !== 'Unknown') {
          maps.add(replay.map);
        }
      });
      const uniqueMaps = maps.size;

      if (totalReplaysEl) totalReplaysEl.textContent = totalReplays.toLocaleString();
      if (totalPlaytimeEl) totalPlaytimeEl.textContent = playtimeText;
      if (uniqueMapsEl) uniqueMapsEl.textContent = String(uniqueMaps);
    }

    function formatDate(dateString) {
      if (!dateString) return 'Unknown Date';
      try {
        return new Date(dateString).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch {
        return 'Unknown Date';
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Could add a toast notification here
        console.log('Link copied to clipboard');
      }).catch(err => {
        console.error('Failed to copy: ', err);
      });
    }

    function displayLeaderboard(entries){
      const leaderboardEl=document.getElementById('leaderboard');
      if(!leaderboardEl) return;
      if(!Array.isArray(entries) || entries.length===0){
        leaderboardEl.innerHTML='<div class="message" style="text-align:center;padding:2rem;color:#8b949e;">No players found</div>';
        hasRenderedLeaderboard=true; return;
      }

      let table = `<table aria-describedby="leaderboardTitle">
        <thead>
          <tr>
            <th scope="col" class="rank">Rank</th>
            <th scope="col">Player</th>
            <th scope="col">Tier</th>
            <th scope="col">Champion Rating</th>
            <th scope="col">Skill (1v1)</th>
            <th scope="col">Record</th>
            <th scope="col">Win Rate</th>
          </tr>
        </thead>
        <tbody>`;

      entries.forEach((entry)=>{
        if (entry.type === 'tier_header') {
          const tierBadge = getTierBadgeHTML(entry.tier);
          table += `<tr class="tier-header-row" style="background:#21262d;border-top:2px solid #30363d;">
            <td colspan="7" style="padding:1rem;text-align:center;font-weight:700;font-size:1.1em;color:#58a6ff;">
              <div class="tier-heading">${tierBadge} ${escapeHtml(entry.tier)} TIER (${escapeHtml(entry.tier_info)}) ${tierBadge}</div>
            </td>
          </tr>`;
        } else if (entry.type === 'tier_separator') {
          table += `<tr class="tier-separator-row" style="height:10px;background:transparent;">
            <td colspan="7" style="padding:0;border:none;"></td>
          </tr>`;
        } else if (entry.type === 'player') {
          const wins = Number(entry.wins)||0, losses=Number(entry.losses)||0;
          const total = wins+losses, winRate = total>0 ? ((wins/total)*100).toFixed(1) : '0.0';
          const crDisplay = Number.isFinite(+entry.current_cr) ? (+entry.current_cr).toLocaleString() : (entry.current_cr ?? 0);
          const name = escapeHtml(entry.player || 'Unknown');
          const tier = entry.tier || 'Bronze';
          const tierClass = `tier-${tier.toLowerCase()}`;
          const tierRank = entry.tier_rank || '?';
          const meta = [entry.team, entry.country].filter(Boolean).map(escapeHtml).join(' &bull; ');
          const metaHtml = meta ? `<span class="player-meta" style="display:block;margin-top:.2rem;color:#8b949e;font-size:.85rem;">${meta}</span>` : '';
          const latestOs = entry.latest_os != null ? Number(entry.latest_os).toFixed(2) : 'N/A';

          table += `<tr class="player-row ${tierClass}">
            <td class="rank">#${tierRank}</td>
            <td><span class="player-name" style="font-weight:600;color:#c9d1d9">${name}</span>${metaHtml}</td>
            <td class="tier-cell">
              <span class="tier-chip" aria-label="${escapeHtml(tier)} tier">
                ${getTierBadgeHTML(tier)}<span>${escapeHtml(tier)}</span>
              </span>
            </td>
            <td class="mmr" style="font-family:'Courier New',monospace;color:#58a6ff;font-weight:600">${crDisplay}</td>
            <td class="os" style="font-family:'Courier New',monospace;color:#79c0ff;font-weight:500">${latestOs}</td>
            <td class="record">${wins}W-${losses}L</td>
            <td class="win-rate">${winRate}%</td>
          </tr>`;
        }
      });

      table += '</tbody></table>';
      leaderboardEl.innerHTML = table;
      hasRenderedLeaderboard = true;
    }

    function updateStats(entries, updatedAt){
      const totalPlayersEl=document.getElementById('total-players');
      const totalMatchesEl=document.getElementById('total-matches');
      const activeTiersEl=document.getElementById('active-tiers');
      const updateTimeEl=document.getElementById('update-time');

      // Filter only player entries
      const players = entries.filter(entry => entry.type === 'player');
      
      const totalPlayers=players.length;
      const totalMatches=Math.floor(players.reduce((s,p)=>s+(+p.wins||0)+(+p.losses||0),0)/2);
      const activeTiers=new Set(players.map(p=>p.tier||'Bronze')).size;

      if(totalPlayersEl) totalPlayersEl.textContent=totalPlayers.toLocaleString();
      if(totalMatchesEl) totalMatchesEl.textContent=totalMatches.toLocaleString();
      if(activeTiersEl) activeTiersEl.textContent=String(activeTiers);
      
      // Use timestamp from data if available, otherwise current time
      if(updateTimeEl) {
        if (updatedAt) {
          const date = new Date(updatedAt);
          updateTimeEl.textContent = date.toLocaleString();
        } else {
          updateTimeEl.textContent = new Date().toLocaleString();
        }
      }
    }

    loadLeaderboard();
    setInterval(loadLeaderboard, REFRESH_INTERVAL_MS);
  </script>
</body>
</html>
