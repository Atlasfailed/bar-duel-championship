<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAR Duel Championship - Replay Database</title>
    <link rel="stylesheet" href="static/css/styles.css">
    <style>
        body{background:#0d1117;color:#c9d1d9;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0}
        .container{max-width:1200px;margin:2rem auto;background:#161b22;border:1px solid #30363d;border-radius:8px;padding:2rem}
        h1{text-align:center;border-bottom:1px solid #30363d;padding-bottom:1rem;margin-top:0;font-size:2.5rem;margin-bottom:1rem}
        .subtitle{text-align:center;color:#8b949e;margin-bottom:1.5rem;font-size:1.1rem}
        
        /* Navigation */
        .nav-back{margin-bottom:1.5rem}
        .nav-back a{color:#58a6ff;text-decoration:none;font-size:0.9rem;display:inline-flex;align-items:center;gap:0.5rem}
        .nav-back a:hover{color:#c9d1d9}
        
        /* Stats grid */
        .summary-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .summary-card{background:#161b22;border:1px solid #30363d;border-radius:8px;padding:20px;text-align:center}
        .summary-number{font-size:2em;color:#58a6ff;font-weight:bold;display:block}
        .summary-label{color:#8b949e;font-size:0.9rem;margin-top:0.5rem}

        /* Filters */
        .filters{background:#161b22;border:1px solid #30363d;padding:20px;border-radius:8px;margin-bottom:20px}
        .filter-row{display:flex;gap:15px;flex-wrap:wrap;align-items:center;margin-bottom:15px}
        .filter-group{display:flex;flex-direction:column;min-width:150px}
        label{font-size:0.9rem;margin-bottom:5px;color:#8b949e}
        select,input{padding:8px 12px;border:1px solid #30363d;border-radius:6px;background:#0d1117;color:#c9d1d9;font-size:0.9rem}
        select:focus,input:focus{outline:none;border-color:#58a6ff}

        /* Replay cards */
        .replay-grid{display:grid;gap:1rem}
        .replay-card{background:#161b22;border:1px solid #30363d;border-radius:8px;padding:1.5rem;transition:all 0.2s ease}
        .replay-card:hover{background:#1c2128;border-color:#58a6ff}
        
        .replay-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
        .replay-title{font-weight:600;color:#c9d1d9;font-size:1.1rem}
        .replay-date{font-size:0.85rem;color:#8b949e}
        
        .players{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding:0.75rem;background:#0d1117;border:1px solid #30363d;border-radius:6px}
        .player{display:flex;flex-direction:column;align-items:center;text-align:center}
        .player-name{font-weight:600;margin-bottom:0.25rem;color:#c9d1d9}
        .player-name.winner{color:#3fb950}
        .player-name:not(.winner){color:#f85149}
        .player-faction{font-size:0.8rem;color:#8b949e}
        .vs{font-size:1.2rem;font-weight:bold;color:#58a6ff}

        .replay-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:1rem}
        .detail-item{text-align:center;padding:0.5rem;background:#0d1117;border-radius:4px;border:1px solid #30363d}
        .detail-label{font-size:0.75rem;color:#8b949e;margin-bottom:0.25rem}
        .detail-value{font-weight:600;color:#c9d1d9;font-size:0.9rem}

        .tags{display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem}
        .tag{background:#1f2328;color:#ffd700;padding:0.25rem 0.5rem;border-radius:12px;font-size:0.75rem;border:1px solid #30363d}

        .replay-actions{display:flex;gap:0.5rem}
        .btn{padding:0.5rem 1rem;border-radius:6px;border:1px solid;cursor:pointer;text-decoration:none;display:inline-block;font-size:0.85rem;transition:all 0.2s ease;font-weight:500}
        .btn-primary{background:#238636;border-color:#238636;color:#fff}
        .btn-primary:hover{background:#2ea043;border-color:#2ea043}
        .btn-secondary{background:#21262d;border-color:#30363d;color:#c9d1d9}
        .btn-secondary:hover{background:#30363d;border-color:#8b949e}

        /* Loading and messages */
        .loading,.no-results,.error{text-align:center;padding:2rem;color:#8b949e;background:#161b22;border:1px solid #30363d;border-radius:8px;margin:1rem 0}
        .error{color:#f85149;border-color:#f85149}

        /* Initial states */
        .replay-grid{display:none}
        .no-results{display:none}

        /* Footer */
        .footer-logo{display:block;margin:2rem auto 0;max-height:70px;opacity:.7}

        /* Responsive */
        @media (max-width: 768px) {
            .container{margin:1rem;padding:1rem}
            h1{font-size:2rem}
            .filter-row{flex-direction:column;align-items:stretch}
            .filter-group{min-width:auto}
            .replay-header{flex-direction:column;align-items:flex-start;gap:0.5rem}
            .players{flex-direction:column;gap:0.5rem;text-align:center}
            .replay-details{grid-template-columns:1fr 1fr}
            .replay-actions{flex-direction:column}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-back">
            <a href="index.html">‚Üê Back to Leaderboard</a>
        </div>
        
        <header>
            <h1>üéÆ Replay Database</h1>
            <p class="subtitle">Discover epic matches and analyze player performance</p>
        </header>

                <div class="summary-stats" id="statsGrid">
            <div class="summary-card">
                <div class="summary-number" id="totalReplays">-</div>
                <div class="summary-label">Total Replays</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalPlayers">-</div>
                <div class="summary-label">Players</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalPlaytime">-</div>
                <div class="summary-label">Total Playtime</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="uniqueMaps">-</div>
                <div class="summary-label">Unique Maps</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="playerFilter">Player</label>
                    <select id="playerFilter">
                        <option value="">All Players</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="mapFilter">Map</label>
                    <select id="mapFilter">
                        <option value="">All Maps</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="durationFilter">Duration</label>
                    <select id="durationFilter">
                        <option value="">All Durations</option>
                        <option value="short">Short (< 10 min)</option>
                        <option value="medium">Medium (10-30 min)</option>
                        <option value="long">Long (30-60 min)</option>
                        <option value="epic">Epic (> 60 min)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Search</label>
                    <input type="text" id="searchFilter" placeholder="Search replays...">
                </div>
            </div>
        </div>

        <div id="loadingMessage" class="loading">
            Loading replay database...
        </div>

        <div id="replayGrid" class="replay-grid">
        </div>

        <div id="noResults" class="no-results">
            No replays found matching your filters.
        </div>
    </div>

    <script>
        let allReplays = [];
        let allPlayers = [];
        let filteredReplays = [];

        // Load replay database
        async function loadReplayDatabase() {
            try {
                const response = await fetch('data/replay_database.json');
                const data = await response.json();
                allReplays = data;
                
                // Load player histories for additional stats
                const playerResponse = await fetch('data/player_match_history.json');
                const playerData = await playerResponse.json();
                allPlayers = Object.keys(playerData);

                initializeFilters();
                updateStats();
                filteredReplays = [...allReplays];
                renderReplays();
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('replayGrid').style.display = 'grid';
            } catch (error) {
                console.error('Error loading replay database:', error);
                document.getElementById('loadingMessage').textContent = 'Error loading replay database';
            }
        }

        function initializeFilters() {
            // Populate player filter
            const playerFilter = document.getElementById('playerFilter');
            const players = new Set();
            allReplays.forEach(replay => {
                replay.player_names.forEach(name => players.add(name));
            });
            [...players].sort().forEach(player => {
                const option = document.createElement('option');
                option.value = player;
                option.textContent = player;
                playerFilter.appendChild(option);
            });

            // Populate map filter
            const mapFilter = document.getElementById('mapFilter');
            const maps = new Set();
            allReplays.forEach(replay => {
                if (replay.map && replay.map !== 'Unknown') {
                    maps.add(replay.map);
                }
            });
            [...maps].sort().forEach(map => {
                const option = document.createElement('option');
                option.value = map;
                option.textContent = map;
                mapFilter.appendChild(option);
            });

            // Add event listeners
            document.getElementById('playerFilter').addEventListener('change', applyFilters);
            document.getElementById('mapFilter').addEventListener('change', applyFilters);
            document.getElementById('durationFilter').addEventListener('change', applyFilters);
            document.getElementById('searchFilter').addEventListener('input', applyFilters);
        }

        function updateStats() {
            document.getElementById('totalReplays').textContent = allReplays.length;
            document.getElementById('totalPlayers').textContent = allPlayers.length;
            
            // Calculate total playtime
            const totalMs = allReplays.reduce((sum, replay) => sum + (replay.duration_ms || 0), 0);
            const totalHours = Math.floor(totalMs / (1000 * 60 * 60));
            document.getElementById('totalPlaytime').textContent = `${totalHours}h`;
            
            // Count unique maps
            const maps = new Set();
            allReplays.forEach(replay => {
                if (replay.map && replay.map !== 'Unknown') {
                    maps.add(replay.map);
                }
            });
            document.getElementById('uniqueMaps').textContent = maps.size;
        }

        function applyFilters() {
            const playerFilter = document.getElementById('playerFilter').value;
            const mapFilter = document.getElementById('mapFilter').value;
            const durationFilter = document.getElementById('durationFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredReplays = allReplays.filter(replay => {
                // Player filter
                if (playerFilter && !replay.player_names.includes(playerFilter)) {
                    return false;
                }

                // Map filter
                if (mapFilter && replay.map !== mapFilter) {
                    return false;
                }

                // Duration filter
                if (durationFilter && !replay.tags.includes(durationFilter)) {
                    return false;
                }

                // Search filter
                if (searchFilter) {
                    const searchText = [
                        replay.map,
                        ...replay.player_names,
                        replay.winner,
                        ...replay.tags
                    ].join(' ').toLowerCase();
                    
                    if (!searchText.includes(searchFilter)) {
                        return false;
                    }
                }

                return true;
            });

            renderReplays();
        }

        function renderReplays() {
            const grid = document.getElementById('replayGrid');
            const noResults = document.getElementById('noResults');

            if (filteredReplays.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noResults.style.display = 'none';

            grid.innerHTML = filteredReplays.map(replay => `
                <div class="replay-card">
                    <div class="replay-header">
                        <div class="replay-title">${replay.map || 'Unknown Map'}</div>
                        <div class="replay-date">${formatDate(replay.date)}</div>
                    </div>
                    
                    <div class="players">
                        <div class="player">
                            <div class="player-name ${replay.players[0]?.is_winner ? 'winner' : 'loser'}">
                                ${replay.players[0]?.name || 'Unknown'}
                            </div>
                            <div class="player-faction">${replay.players[0]?.faction || 'Unknown'}</div>
                        </div>
                        <div class="vs">VS</div>
                        <div class="player">
                            <div class="player-name ${replay.players[1]?.is_winner ? 'winner' : 'loser'}">
                                ${replay.players[1]?.name || 'Unknown'}
                            </div>
                            <div class="player-faction">${replay.players[1]?.faction || 'Unknown'}</div>
                        </div>
                    </div>

                    <div class="replay-details">
                        <div class="detail-item">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${replay.duration_formatted}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Winner</div>
                            <div class="detail-value">${replay.winner}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Engine</div>
                            <div class="detail-value">${replay.engine_version || 'Unknown'}</div>
                        </div>
                    </div>

                    <div class="tags">
                        ${replay.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>

                    <div class="replay-actions">
                        <a href="${replay.url}" target="_blank" class="btn btn-primary">View Replay</a>
                        <button class="btn btn-secondary" onclick="copyReplayLink('${replay.url}')">Copy Link</button>
                    </div>
                </div>
            `).join('');
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown Date';
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch {
                return 'Unknown Date';
            }
        }

        function copyReplayLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                // Could add a toast notification here
                console.log('Replay link copied to clipboard');
            });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadReplayDatabase);
    </script>
</body>
</html>